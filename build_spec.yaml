version: 0.1
component: build
timeoutInSeconds: 10000
shell: bash
failImmediatelyOnError: true
env:
  vaultVariables:
    # Ensure that this vault secret contains a single-line base64-encoded key.
    SOPS_PGP_KEY: "ocid1.vaultsecret.oc1.iad.amaaaaaarhu4k2aalfuxr577tgsphedqodulqamf7lkrmtf7scclr6g2xa7a"
steps:
  - type: Command
    name: "Install Dependencies"
    shell: bash
    timeoutInSeconds: 600
    failImmediatelyOnError: true
    command: |
      # (Optional) Log a snippet of the SOPS key for tracking purposes.
      echo "SOPS key prefix: $(echo "$SOPS_PGP_KEY" | head -c 10)"
      
      # Install utilities, including yum-utils, tmux, gnupg, and unzip
      yum install -y yum-utils tmux gnupg unzip
      
      # Instead of using the failing HashiCorp repository, download Packer manually
      # (Replace 1.7.10 with your desired Packer version)
      curl -Lo packer.zip https://releases.hashicorp.com/packer/1.7.10/packer_1.7.10_linux_amd64.zip
      unzip packer.zip -d /usr/local/bin/
      chmod +x /usr/local/bin/packer
      rm -f packer.zip

      # Install SOPS by downloading the pre-built binary
      curl -Lo /usr/local/bin/sops https://github.com/mozilla/sops/releases/download/v3.9.4/sops-v3.9.4.linux.amd64
      chmod +x /usr/local/bin/sops

  - type: Command
    name: "Setup Python Environment"
    shell: bash
    timeoutInSeconds: 600
    failImmediatelyOnError: true
    command: |
      # Install Python 3.6 (available on Oracle Linux 7)
      yum install -y python36
      # Upgrade pip and setuptools using Python 3.6
      python3.6 -m pip install --upgrade pip setuptools
      # Create a virtual environment using Python 3.6
      python3.6 -m venv packer_env
      source packer_env/bin/activate
      # Upgrade pip again within the virtual environment
      python -m pip install --upgrade pip
      # Install ansible-core (specific version required)
      pip install ansible-core==2.13.13

  - type: Command
    name: "Install Ansible Galaxy Roles"
    shell: bash
    timeoutInSeconds: 300
    failImmediatelyOnError: true
    command: |
      ansible-galaxy install -r ./requirements.yml

  - type: Command
    name: "Decrypt Defaults File"
    shell: bash
    timeoutInSeconds: 300
    failImmediatelyOnError: true
    command: |
      # Decode the base64-encoded SOPS PGP private key (from OCI Vault) and import it into GPG
      echo "$SOPS_PGP_KEY" | base64 --decode | gpg --import
      # Decrypt the encrypted defaults file to produce defaults.packer.hcl
      sops --decrypt defaults.packer.hcl.enc > defaults.packer.hcl

  - type: Command
    name: "Build Custom Image"
    shell: bash
    timeoutInSeconds: 3600
    failImmediatelyOnError: true
    command: |
      # Extract build_config_path from the decrypted defaults file
      build_config_path=$(grep '^build_config_path' defaults.packer.hcl | cut -d '=' -f2 | tr -d ' "')
      echo "Using build_config_path: ${build_config_path}"
      # Run packer init and build using the extracted build_config_path
      tmux new -d -s packer_session "packer init ${build_config_path} && packer build -var-file='defaults.packer.hcl' ${build_config_path}"
      tmux attach-session -t packer_session

  - type: Command
    name: "Cleanup Decrypted File"
    shell: bash
    timeoutInSeconds: 60
    failImmediatelyOnError: false
    command: |
      # Remove the decrypted configuration file to secure sensitive data
      rm -f defaults.packer.hcl
